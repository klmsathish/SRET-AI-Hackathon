<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  
      <!-- JavaScript Bundle with Popper -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
      <!-- CSS only -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <title>Home Page</title>
  </head>
    <nav class="navbar navbar-expand-lg navbar navbar-dark bg-primary">
      
      <div class="container"><a href="home" class="navbar-brand d-flex align-items-center"><i class="fa-solid fa-stethoscope" ></i>&ensp;<strong>HEALTHLARM</strong></a>
        <button type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"><span class="navbar-toggler-icon"></span></button>
        <div id="navbarSupportedContent" class="collapse navbar-collapse">
          <ul class="navbar-nav ml-auto" style = "font-size: 19px;">
            
            <li class="nav-item active"><a href="about" class="nav-link font-italic"> About </a></li>
            <li class="nav-item active"><a href="services" class="nav-link font-italic"> Services </a></li>
  <li class="nav-item active"><a href="addMemories" class="nav-link font-italic">Add Memories</a></li> <li class="nav-item active"><a href="blind" class="nav-link font-italic"> Blind Mode</a></li>   
 <li class="nav-item active"><a href="team" class="nav-link font-italic"> Contact</a></li>


  <li class="nav-item active"><a href="#" class="nav-link font-italic" style = "padding-left: 400px;"> Hello, Sathishkumar</a></li>
            <div class="user-menu-wrap">
  
          </ul>
        </div>
      </div>
    </nav>
  
  <script class="jsbin" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  <div class="file-upload">
    <div class="image-upload-wrap">
      <input class="file-upload-input" type='file' onchange="readURL(this);" accept="image/*" />
      <div class="drag-text">
        <h3>Drag or browse for Image</h3>
      </div>
    </div>
    
    <div class="file-upload-content">
      <img class="file-upload-image" src="#" alt="your image" />
      <div class="image-title-wrap">
        <button type="button" onclick="removeUpload()" class="remove-image">Remove <span class="image-title">Uploaded Image</span></button>
      </div>
    </div>
    <br>
    <br>
    <button class="file-upload-btn" type="button" onclick="$('.file-upload-input').trigger( 'click' )">Add Image</button>
    <br>
    <br>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- <script src="https://unpkg.com/feather-icons"></script> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style>
        /*body{
          min-height: 100vh;
          display: block;
          justify-content: center;
        }*/
        #msg {
            visibility: hidden;
            color: red;
            /*font-weight: bold;*/
            margin-top: 10px;
            font-size: 22px;
            /*font-family: Verdana;*/
          }
          button {
            padding: 5px 10px;
            border: 1px solid grey;
            font-size: 18px;
            background: white;
            cursor: pointer;
          }
          #stop{
              display: none;
          }
          #download{
            visibility: hidden;
          }
          .audio-controls {
            display: flex;
            align-items: center;
            padding-top: 20px;
            justify-content: center;
          }
          .audio-controls button {
            margin: 0px 5px;
          }
          canvas {
            margin-top: 10px;
            background-color: black;
            border-radius: 10px;
          }
          select {
            height: 25px;
            margin: 0px 5px;
          }
          a {
            margin-left: 20px;
            text-decoration: none;
          }
          .app {
            text-align: center;
            padding-top: 20px;
          }
          body {
  font-family: sans-serif;
  background-color: #eeeeee;
}

.file-upload {
  background-color: #ffffff;
  width: 600px;
  margin: 0 auto;
  padding: 20px;
}

.file-upload-btn {
  width: 100%;
  margin: 0;
  color: #fff;
  background: #1FB264;
  border: none;
  padding: 10px;
  border-radius: 4px;
  border-bottom: 4px solid #15824B;
  transition: all .2s ease;
  outline: none;
  text-transform: uppercase;
  font-weight: 700;
}

.file-upload-btn:hover {
  background: #1AA059;
  color: #ffffff;
  transition: all .2s ease;
  cursor: pointer;
}

.file-upload-btn:active {
  border: 0;
  transition: all .2s ease;
}

.file-upload-content {
  display: none;
  text-align: center;
}

.file-upload-input {
  position: absolute;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  outline: none;
  opacity: 0;
  cursor: pointer;
}

.image-upload-wrap {
  margin-top: 20px;
  border: 4px dashed #1FB264;
  position: relative;
}

.image-dropping,
.image-upload-wrap:hover {
  background-color: #1FB264;
  border: 4px dashed #ffffff;
}

.image-title-wrap {
  padding: 0 15px 15px 15px;
  color: #222;
}

.drag-text {
  text-align: center;
}

.drag-text h3 {
  font-weight: 100;
  text-transform: uppercase;
  color: #15824B;
  padding: 60px 0;
}

.file-upload-image {
  max-height: 200px;
  max-width: 200px;
  margin: auto;
  padding: 20px;
}

.remove-image {
  width: 200px;
  margin: 0;
  color: #fff;
  background: #cd4535;
  border: none;
  padding: 10px;
  border-radius: 4px;
  border-bottom: 4px solid #b02818;
  transition: all .2s ease;
  outline: none;
  text-transform: uppercase;
  font-weight: 700;
}

.remove-image:hover {
  background: #c13b2a;
  color: #ffffff;
  transition: all .2s ease;
  cursor: pointer;
}

.remove-image:active {
  border: 0;
  transition: all .2s ease;
}

    </style>
</head>
<body>
    <div class="app">
        <select name="" id="micSelect"></select>
      
        <select id="visSelect">
          <option value="frequencybars">Bar</option>
      <!--     <option value="sinewave">Wave</option> -->
          <option value="circle">Circle</option>
        </select>
      
        <a id="download">Download</a>
      
        <div class="audio-controls">
          <button id="record" class="btn btn-outline-danger">Record</button>
          <button id="stop" class="btn btn-outline-success">Stop</button>
          <audio id="audio" controls></audio>
        </div>
      
        <div id="msg">Recording...</div>
        <canvas width="500" height="300"></canvas>
      <div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script>
    (async () => {
        let leftchannel = [];
        let rightchannel = [];
        let recorder = null;
        let recording = false;
        let recordingLength = 0;
        let volume = null;
        let audioInput = null;
        let sampleRate = null;
        let AudioContext = window.AudioContext || window.webkitAudioContext;
        let context = null;
        let analyser = null;
        let canvas = document.querySelector('canvas');
        let canvasCtx = canvas.getContext("2d");
        let visualSelect = document.querySelector('#visSelect');
        let micSelect = document.querySelector('#micSelect');
        let stream = null;
        let tested = false;
        
        try {
          window.stream = stream = await getStream();
          console.log('Got stream');  
        } catch(err) {
          alert('Issue getting mic', err);
        }
        
        const deviceInfos = await navigator.mediaDevices.enumerateDevices();
        
        var mics = [];
        for (let i = 0; i !== deviceInfos.length; ++i) {
          let deviceInfo = deviceInfos[i];
          if (deviceInfo.kind === 'audioinput') {
            mics.push(deviceInfo);
            let label = deviceInfo.label ||
              'Microphone ' + mics.length;
            console.log('Mic ', label + ' ' + deviceInfo.deviceId)
            const option = document.createElement('option')
            option.value = deviceInfo.deviceId;
            option.text = label;
            micSelect.appendChild(option);
          }
        }
        
        function getStream(constraints) {
          if (!constraints) {
            constraints = { audio: true, video: false };
          }
          return navigator.mediaDevices.getUserMedia(constraints);
        }
        
        
        setUpRecording();
        
        function setUpRecording() {
          context = new AudioContext();
          sampleRate = context.sampleRate;
          
          // creates a gain node
          volume = context.createGain();
          
          // creates an audio node from teh microphone incoming stream
          audioInput = context.createMediaStreamSource(stream);
          
          // Create analyser
          analyser = context.createAnalyser();
          
          // connect audio input to the analyser
          audioInput.connect(analyser);
          
          // connect analyser to the volume control
          // analyser.connect(volume);
          
          let bufferSize = 2048;
          let recorder = context.createScriptProcessor(bufferSize, 2, 2);
          
          // we connect the volume control to the processor
          // volume.connect(recorder);
          
          analyser.connect(recorder);
          
          // finally connect the processor to the output
          recorder.connect(context.destination); 
      
          recorder.onaudioprocess = function(e) {
            // Check 
            if (!recording) return;
            // Do something with the data, i.e Convert this to WAV
            console.log('recording');
            let left = e.inputBuffer.getChannelData(0);
            let right = e.inputBuffer.getChannelData(1);
            if (!tested) {
              tested = true;
              // if this reduces to 0 we are not getting any sound
              if ( !left.reduce((a, b) => a + b) ) {
                alert("There seems to be an issue with your Mic");
                // clean up;
                stop();
                stream.getTracks().forEach(function(track) {
                  track.stop();
                });
                context.close();
              }
            }
            // we clone the samples
            leftchannel.push(new Float32Array(left));
            rightchannel.push(new Float32Array(right));
            recordingLength += bufferSize;
          };
          visualize();
        };
        
        
      
        function mergeBuffers(channelBuffer, recordingLength) {
          let result = new Float32Array(recordingLength);
          let offset = 0;
          let lng = channelBuffer.length;
          for (let i = 0; i < lng; i++){
            let buffer = channelBuffer[i];
            result.set(buffer, offset);
            offset += buffer.length;
          }
          return result;
        }
        
        function interleave(leftChannel, rightChannel){
          let length = leftChannel.length + rightChannel.length;
          let result = new Float32Array(length);
      
          let inputIndex = 0;
      
          for (let index = 0; index < length; ){
            result[index++] = leftChannel[inputIndex];
            result[index++] = rightChannel[inputIndex];
            inputIndex++;
          }
          return result;
        }
        
        function writeUTFBytes(view, offset, string){ 
          let lng = string.length;
          for (let i = 0; i < lng; i++){
            view.setUint8(offset + i, string.charCodeAt(i));
          }
        }
      
        function start() {
          recording = true;
          document.querySelector('#msg').style.visibility = 'visible'
          document.querySelector('#stop').style.display = 'block'
          document.querySelector('#record').style.display = 'none'
          // reset the buffers for the new recording
          leftchannel.length = rightchannel.length = 0;
          recordingLength = 0;
          console.log('context: ', !!context);
          if (!context) setUpRecording();
        }
      
        function stop() {
          console.log('Stop')
          recording = false;
          document.querySelector('#msg').style.visibility = 'hidden'
          document.querySelector('#record').style.display = 'block'
          document.querySelector('#download').style.visibility = 'visible'
          document.querySelector('#stop').style.display = 'none'
          
          // we flat the left and right channels down
          let leftBuffer = mergeBuffers ( leftchannel, recordingLength );
          let rightBuffer = mergeBuffers ( rightchannel, recordingLength );
          // we interleave both channels together
          let interleaved = interleave ( leftBuffer, rightBuffer );
          
          ///////////// WAV Encode /////////////////
          // from http://typedarray.org/from-microphone-to-wav-with-getusermedia-and-web-audio/
          //
      
          // we create our wav file
          let buffer = new ArrayBuffer(44 + interleaved.length * 2);
          let view = new DataView(buffer);
      
          // RIFF chunk descriptor
          writeUTFBytes(view, 0, 'RIFF');
          view.setUint32(4, 44 + interleaved.length * 2, true);
          writeUTFBytes(view, 8, 'WAVE');
          // FMT sub-chunk
          writeUTFBytes(view, 12, 'fmt ');
          view.setUint32(16, 16, true);
          view.setUint16(20, 1, true);
          // stereo (2 channels)
          view.setUint16(22, 2, true);
          view.setUint32(24, sampleRate, true);
          view.setUint32(28, sampleRate * 4, true);
          view.setUint16(32, 4, true);
          view.setUint16(34, 16, true);
          // data sub-chunk
          writeUTFBytes(view, 36, 'data');
          view.setUint32(40, interleaved.length * 2, true);
      
          // write the PCM samples
          let lng = interleaved.length;
          let index = 44;
          let volume = 1;
          for (let i = 0; i < lng; i++){
              view.setInt16(index, interleaved[i] * (0x7FFF * volume), true);
              index += 2;
          }
      
          // our final binary blob
          const blob = new Blob ( [ view ], { type : 'audio/wav' } );
          
          const audioUrl = URL.createObjectURL(blob);
          console.log('BLOB ', blob);
          console.log('URL ', audioUrl);
          document.querySelector('#audio').setAttribute('src', audioUrl);
          const link = document.querySelector('#download');
          link.setAttribute('href', audioUrl);
          link.download = 'output.wav';
        }
        
        // Visualizer function from
        // https://webaudiodemos.appspot.com/AudioRecorder/index.html
        //
        function visualize() {
          WIDTH = canvas.width;
          HEIGHT = canvas.height;
          CENTERX = canvas.width / 2;
          CENTERY = canvas.height / 2;
      
          let visualSetting = visualSelect.value;
          console.log(visualSetting);
          if (!analyser) return;
      
          if(visualSetting === "sinewave") {
            analyser.fftSize = 2048;
            var bufferLength = analyser.fftSize;
            console.log(bufferLength);
            var dataArray = new Uint8Array(bufferLength);
      
            canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
      
            var draw = function() {
      
              drawVisual = requestAnimationFrame(draw);
      
              analyser.getByteTimeDomainData(dataArray);
      
              canvasCtx.fillStyle = 'rgb(200, 200, 200)';
              canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
      
              canvasCtx.lineWidth = 2;
              canvasCtx.strokeStyle = 'rgb(0, 0, 0)';
      
              canvasCtx.beginPath();
      
              var sliceWidth = WIDTH * 1.0 / bufferLength;
              var x = 0;
      
              for(var i = 0; i < bufferLength; i++) {
      
                var v = dataArray[i] / 128.0;
                var y = v * HEIGHT/2;
      
                if(i === 0) {
                  canvasCtx.moveTo(x, y);
                } else {
                  canvasCtx.lineTo(x, y);
                }
      
                x += sliceWidth;
              }
      
              canvasCtx.lineTo(canvas.width, canvas.height/2);
              canvasCtx.stroke();
            };
      
            draw();
      
          } else if(visualSetting == "frequencybars") {
            analyser.fftSize = 64;
            var bufferLengthAlt = analyser.frequencyBinCount;
            console.log(bufferLengthAlt);
            var dataArrayAlt = new Uint8Array(bufferLengthAlt);
      
            canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
      
            var drawAlt = function() {
              drawVisual = requestAnimationFrame(drawAlt);
      
              analyser.getByteFrequencyData(dataArrayAlt);
      
              canvasCtx.fillStyle = 'rgb(0, 0, 0)';
              canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
      
              var barWidth = (WIDTH / bufferLengthAlt);
              var barHeight;
              var x = 0;
      
              for(var i = 0; i < bufferLengthAlt; i++) {
                barHeight = dataArrayAlt[i];
      
                canvasCtx.fillStyle = 'rgb(' + (barHeight+100) + ',50,50)';
                canvasCtx.fillRect(x,HEIGHT-barHeight/2,barWidth,barHeight/2);
      
                x += barWidth + 1;
              }
            };
      
            drawAlt();
      
          } else if(visualSetting == "circle") {
            analyser.fftSize = 32;
            let bufferLength = analyser.frequencyBinCount;
            console.log(bufferLength);
            let dataArray = new Uint8Array(bufferLength);
      
            canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
            
            let draw = () => {
              drawVisual = requestAnimationFrame(draw);
              
              analyser.getByteFrequencyData(dataArray);
              canvasCtx.fillStyle = 'rgb(0, 0, 0)';
              canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
              
              // let radius = dataArray.reduce((a,b) => a + b) / bufferLength;
              let radius = dataArray[2] / 2
              if (radius < 20) radius = 20;
              if (radius > 100) radius = 100;
              // console.log('Radius ', radius)
              canvasCtx.beginPath();
              canvasCtx.arc(CENTERX, CENTERY, radius, 0, 2 * Math.PI, false);
              // canvasCtx.fillStyle = 'rgb(50,50,' + (radius+100) +')';
              // canvasCtx.fill();
              canvasCtx.lineWidth = 6;
              canvasCtx.strokeStyle = 'rgb(50,50,' + (radius+100) +')';
              canvasCtx.stroke();
            }
            draw()
          }
      
        }
        
        visualSelect.onchange = function() {
          window.cancelAnimationFrame(drawVisual);
          visualize();
        };
        
        micSelect.onchange = async e => {
          console.log('now use device ', micSelect.value);
          stream.getTracks().forEach(function(track) {
            track.stop();
          });
          context.close();
          
          stream = await getStream({ audio: {
            deviceId: {exact: micSelect.value} }, video: false });
          setUpRecording();
        }
      
        function pause() {
          recording = false;
          context.suspend()
        }
      
        function resume() {
          recording = true;
          context.resume();
        }
      
        document.querySelector('#record').onclick = (e) => {
          console.log('Start recording')
          start();
        }
      
        document.querySelector('#stop').onclick = (e) => {
          stop();
        }

      })()
      function readURL(input) {
  if (input.files && input.files[0]) {

    var reader = new FileReader();

    reader.onload = function(e) {
      $('.image-upload-wrap').hide();

      $('.file-upload-image').attr('src', e.target.result);
      $('.file-upload-content').show();

      $('.image-title').html(input.files[0].name);
    };

    reader.readAsDataURL(input.files[0]);

  } else {
    removeUpload();
  }
}

function removeUpload() {
  $('.file-upload-input').replaceWith($('.file-upload-input').clone());
  $('.file-upload-content').hide();
  $('.image-upload-wrap').show();
}
$('.image-upload-wrap').bind('dragover', function () {
    $('.image-upload-wrap').addClass('image-dropping');
  });
  $('.image-upload-wrap').bind('dragleave', function () {
    $('.image-upload-wrap').removeClass('image-dropping');
});
</script>
</body>
</html>